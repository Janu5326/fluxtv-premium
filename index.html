<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FluxTV Premium — M3U Player</title>

<!-- Font + Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<!-- HLS.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.5/dist/hls.min.js"></script>

<style>
  /* ===== Base variables (mobile-first) ===== */
  :root{
    --bg:#0b1220; --card:#0f1724; --muted:#9fb0d6; --text:#e6eef8;
    --accent:#1e3a8a; --accent-2:#2563eb;
    --gradient-primary:linear-gradient(135deg,var(--accent),var(--accent-2));
    --glass: rgba(255,255,255,0.03);
    --shadow-lg: 0 8px 22px rgba(2,6,23,0.6);
    --shadow-xl: 0 18px 40px rgba(2,6,23,0.7);
    --radius:14px; --nav-h:72px;
    --trans: 220ms cubic-bezier(.2,.9,.3,1);
    font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  body[data-theme="light"]{
    --bg:#f6f9fc; --card:#ffffff; --muted:#64748b; --text:#071128; --glass:rgba(2,6,23,0.03);
    --shadow-lg:0 8px 22px rgba(15,23,42,0.06); --shadow-xl:0 16px 40px rgba(15,23,42,0.06);
  }
  body[data-theme-color="navy"]{ --accent:#0f1724; --accent-2:#1e3a8a; }
  body[data-theme-color="blue"]{ --accent:#1e40af; --accent-2:#3b82f6; }
  body[data-theme-color="teal"]{ --accent:#0d9488; --accent-2:#14b8a6; }
  body[data-theme-color="purple"]{ --accent:#7c3aed; --accent-2:#a78bfa; }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;display:flex;align-items:center;flex-direction:column;padding:10px;gap:12px}
  .app{width:100%; max-width:1100px; display:flex; flex-direction:column; gap:12px;}

  /* Header */
  header.app-header{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);box-shadow:var(--shadow-lg)}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:46px;height:46px;border-radius:12px;display:grid;place-items:center;background:var(--gradient-primary);color:#fff;font-weight:800}
  .header-actions{display:flex;gap:8px;align-items:center}
  .icon-btn{background:transparent;border:0;color:var(--text);padding:8px;border-radius:10px;cursor:pointer}
  .search-mini{min-width:140px;padding:8px 12px;border-radius:10px;background:var(--card);display:flex;align-items:center;gap:8px;box-shadow:var(--shadow-lg);cursor:pointer}

  /* Main screens */
  main.app-body{display:flex;flex-direction:column;gap:12px;width:100%}
  .screen{display:none;gap:12px}
  .screen.active{display:flex}

  /* Hero */
  .hero{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;background:var(--card);box-shadow:var(--shadow-lg);overflow:hidden}
  .stats{display:flex;gap:8px;margin-top:10px}
  .stat{background:var(--glass);padding:8px 12px;border-radius:10px;text-align:center}

  /* lists */
  .horizontal{display:flex;gap:10px;overflow:auto;padding:8px;align-items:flex-start}
  .card{min-width:120px;max-width:260px;background:var(--card);border-radius:12px;padding:10px;box-shadow:var(--shadow-lg);flex:0 0 auto}
  .playlist .thumb{height:84px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700}
  .small{font-size:13px;color:var(--muted)}

  /* grid */
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}

  /* channel card */
  .channel-card{padding:10px;border-radius:12px;background:var(--card);display:flex;flex-direction:column;gap:8px}
  .channel-thumb{width:100%;height:96px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;color:var(--text);font-weight:700}

  /* Player */
  .player-wrap{position:sticky;top:12px;z-index:40;border-radius:14px;overflow:hidden;background:linear-gradient(180deg, rgba(0,0,0,0.16), transparent);box-shadow:var(--shadow-xl)}
  .video-area{position:relative;background:#000}
  video#player{width:100%;height:220px;background:#000;display:block}
  .player-controls{display:flex;justify-content:space-between;align-items:center;padding:10px;gap:8px}
  .btn{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.04)}

  /* suggested */
  .suggested .card{min-width:120px}

  /* bottom nav */
  nav.bottom-nav{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);width:calc(100% - 24px);max-width:1100px;height:var(--nav-h);background:var(--card);border-radius:18px;display:flex;justify-content:space-around;align-items:center;box-shadow:var(--shadow-xl);z-index:60}
  .nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;font-size:12px;color:var(--muted);cursor:pointer;padding:8px;border-radius:10px}
  .nav-item.active{color:var(--accent);transform:translateY(-4px)}

  /* mini player */
  .mini-player{position:fixed;bottom:100px;right:18px;width:240px;height:140px;border-radius:12px;overflow:hidden;box-shadow:var(--shadow-xl);background:var(--card);z-index:90;display:flex;flex-direction:column}
  .mini-player video{width:100%;height:100%;object-fit:cover}

  /* overlay & modal */
  .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.5);display:none;z-index:80;backdrop-filter: blur(2px);align-items:center;justify-content:center}
  .overlay.show{display:flex}
  .modal{width:calc(100% - 64px);max-width:720px;background:var(--card);border-radius:14px;padding:16px;box-shadow:var(--shadow-xl)}
  .modal h3{margin-top:0}

  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);color:var(--text);resize:vertical}
  label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block}
  .row{display:flex;gap:8px}
  .row>*{flex:1}

  @media (max-width:768px){ video#player{height:200px} .hero{flex-direction:column} .nav-item span{display:none} }
  @media (max-width:480px){ video#player{height:160px} .card{min-width:120px} }

  .fade-in{animation:fadeIn .36s ease both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
</style>
</head>
<body data-theme="dark" data-theme-color="navy">

<div class="app" id="app">
  <!-- Header -->
  <header class="app-header">
    <div class="brand">
      <div class="logo">Fx</div>
      <div>
        <div style="font-weight:700">FluxTV Premium</div>
        <div class="small">Live TV • M3U-powered</div>
      </div>
    </div>
    <div class="header-actions">
      <div class="search-mini" id="goSearch" role="button" tabindex="0"><i class="fa fa-search"></i><span style="margin-left:8px" class="small">Search</span></div>
      <button class="icon-btn" id="openImport" title="Import M3U"><i class="fa fa-file-import"></i></button>
      <button class="icon-btn" id="openSettings" title="Settings"><i class="fa fa-gear"></i></button>
      <button class="icon-btn" id="openEPG" title="EPG"><i class="fa fa-calendar-days"></i></button>
    </div>
  </header>

  <main class="app-body">
    <!-- Home -->
    <section id="home" class="screen active fade-in">
      <div class="hero">
        <div style="flex:1">
          <h2 style="margin:0">Welcome — FluxTV</h2>
          <div class="small">अपनी M3U फ़ाइल अपलोड करो और तुरंत देखें</div>
          <div class="stats">
            <div class="stat"><small>Total Channels</small><strong id="statChannels">0</strong></div>
            <div class="stat"><small>Favorites</small><strong id="statFavs">0</strong></div>
            <div class="stat"><small>Categories</small><strong id="statCats">0</strong></div>
          </div>
        </div>
        <div style="width:120px;height:72px;border-radius:12px;background:var(--gradient-primary);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;box-shadow:var(--shadow-xl)">M3U</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="btnImportTop">Upload M3U</button>
        <button class="btn ghost" id="btnClearAll">Clear Channels</button>
      </div>

      <h3 style="margin:6px 6px 0 6px">Popular Channels</h3>
      <div class="horizontal suggested" id="popular"></div>

      <h3 style="margin:6px 6px 0 6px">Browse by Category</h3>
      <div class="horizontal categories" id="categories"></div>

      <h3 style="margin:6px 6px 0 6px">Recently Watched</h3>
      <div class="horizontal" id="recently"></div>
    </section>

    <!-- Search -->
    <section id="search" class="screen fade-in">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="searchInput" placeholder="Search channel..." />
        <select id="filterCategory"><option value="">All categories</option></select>
        <select id="filterLang"><option value="">All languages</option></select>
        <select id="filterQuality"><option value="">Any quality</option><option>Auto</option><option>1080p</option><option>720p</option><option>480p</option></select>
        <button class="btn" id="clearFilters">Clear</button>
      </div>
      <div style="margin-top:12px" id="searchResults" class="grid"></div>
      <div id="noResults" class="small" style="display:none;margin-top:12px">No matches</div>
    </section>

    <!-- Player -->
    <section id="player" class="screen fade-in">
      <div class="player-wrap">
        <div class="player" id="playerComponent">
          <div class="video-area">
            <video id="player" controls playsinline poster="" crossorigin="anonymous"></video>
            <div style="position:absolute;right:10px;top:8px;display:flex;gap:8px">
              <button class="icon-btn" id="btnFav" title="Favorite"><i class="fa fa-heart"></i></button>
              <button class="icon-btn" id="btnMini" title="Mini player"><i class="fa fa-window-minimize"></i></button>
              <button class="icon-btn" id="btnFullscreen" title="Fullscreen"><i class="fa fa-expand"></i></button>
            </div>
          </div>
          <div class="player-controls">
            <div class="player-meta">
              <div>
                <div id="playerTitle" style="font-weight:700">--</div>
                <small id="playerInfo" class="small">Category • Quality • Status</small>
              </div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="qualitySelect" style="padding:8px;border-radius:10px;background:transparent;color:var(--text)"></select>
              <button class="btn ghost" id="btnBack"><i class="fa fa-arrow-left"></i> Back</button>
            </div>
          </div>
        </div>
      </div>
      <h4 style="margin:8px 6px 0 6px">Suggested</h4>
      <div class="horizontal suggested" id="playerSuggested"></div>
    </section>

    <!-- Favorites -->
    <section id="favorites" class="screen fade-in">
      <h3>Favorites</h3>
      <div id="favoritesList" class="horizontal"></div>
      <div id="favoritesEmpty" class="small" style="display:none;padding:12px">No favorites yet.</div>
    </section>

    <!-- Settings -->
    <section id="settings" class="screen fade-in">
      <h3>Settings</h3>
      <div style="display:flex;flex-direction:column;gap:12px">
        <div style="padding:10px;border-radius:12px;background:var(--card);box-shadow:var(--shadow-lg)">
          <label>Appearance</label>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn" id="toggleTheme">Toggle Dark/Light</button>
            <select id="themeColor">
              <option value="navy">Navy</option><option value="blue">Blue</option><option value="teal">Teal</option><option value="purple">Purple</option>
            </select>
          </div>
        </div>
        <div style="padding:10px;border-radius:12px;background:var(--card);box-shadow:var(--shadow-lg)">
          <label>Playback</label>
          <div style="display:flex;gap:8px;align-items:center">
            <label style="margin:0"><input type="checkbox" id="autoplayToggle"> Autoplay</label>
            <label style="margin:0"><input type="checkbox" id="pipToggle" checked> Mini player allowed</label>
          </div>
        </div>
        <div style="padding:10px;border-radius:12px;background:var(--card);box-shadow:var(--shadow-lg)">
          <label>Data</label>
          <div style="display:flex;gap:8px">
            <button class="btn ghost" id="clearCache">Clear localStorage</button>
            <button class="btn" id="exportFavs">Export favorites</button>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- bottom nav -->
  <nav class="bottom-nav" role="navigation">
    <div class="nav-item active" data-screen="home"><i class="fa fa-house"></i><span>Home</span></div>
    <div class="nav-item" data-screen="search"><i class="fa fa-search"></i><span>Search</span></div>
    <div class="nav-item" data-screen="player"><i class="fa fa-play-circle"></i><span>Player</span></div>
    <div class="nav-item" data-screen="favorites"><i class="fa fa-heart"></i><span>Favs</span></div>
    <div class="nav-item" data-screen="settings"><i class="fa fa-gear"></i><span>Settings</span></div>
  </nav>
</div>

<!-- overlay / modal -->
<div class="overlay" id="overlay"><div class="modal" id="modalContent"></div></div>
<div id="miniPlayerContainer"></div>

<script>
/* ===== storage keys & state ===== */
const LS = { favorites:'flux_favs_v1', settings:'flux_settings_v1', channels:'flux_channels_v1', recent:'flux_recent_v1' };
const state = { channels: [], favorites: new Set(), settings:{ theme:'dark', color:'navy', autoplay:false, pip:true }, current:null, hls:null, recent:[] };

/* ===== sample (empty) - channels will come from M3U import ===== */
const sample = []; // kept empty; user will import M3U

/* ===== load saved ===== */
function loadState(){
  const saved = JSON.parse(localStorage.getItem(LS.channels) || 'null');
  state.channels = saved || sample;
  const favs = JSON.parse(localStorage.getItem(LS.favorites) || '[]'); state.favorites = new Set(favs);
  state.settings = Object.assign(state.settings, JSON.parse(localStorage.getItem(LS.settings) || '{}'));
  state.recent = JSON.parse(localStorage.getItem(LS.recent) || '[]');
}
loadState();

/* ===== save helpers ===== */
function saveChannels(){ localStorage.setItem(LS.channels, JSON.stringify(state.channels)); }
function saveFavorites(){ localStorage.setItem(LS.favorites, JSON.stringify(Array.from(state.favorites))); renderFavorites(); updateStats(); }
function saveSettings(){ localStorage.setItem(LS.settings, JSON.stringify(state.settings)); applyTheme(); }
function saveRecent(){ localStorage.setItem(LS.recent, JSON.stringify(state.recent.slice(0,30))); }

/* ===== dom refs ===== */
const screens = document.querySelectorAll('.screen');
const navItems = document.querySelectorAll('.nav-item');
const popularEl = document.getElementById('popular');
const categoriesEl = document.getElementById('categories');
const recentlyEl = document.getElementById('recently');
const searchInput = document.getElementById('searchInput');
const filterCategory = document.getElementById('filterCategory');
const filterLang = document.getElementById('filterLang');
const filterQuality = document.getElementById('filterQuality');
const searchResults = document.getElementById('searchResults');
const noResults = document.getElementById('noResults');
const statChannels = document.getElementById('statChannels');
const statFavs = document.getElementById('statFavs');
const statCats = document.getElementById('statCats');
const favoritesList = document.getElementById('favoritesList');
const favoritesEmpty = document.getElementById('favoritesEmpty');

const playerVideo = document.getElementById('player');
const qualitySelect = document.getElementById('qualitySelect');
const playerTitle = document.getElementById('playerTitle');
const playerInfo = document.getElementById('playerInfo');
const btnFav = document.getElementById('btnFav');
const btnMini = document.getElementById('btnMini');
const btnFullscreen = document.getElementById('btnFullscreen');
const btnBack = document.getElementById('btnBack');
const playerSuggested = document.getElementById('playerSuggested');

const overlay = document.getElementById('overlay');
const modalContent = document.getElementById('modalContent');
const miniContainer = document.getElementById('miniPlayerContainer');

/* ===== theme apply ===== */
function applyTheme(){ document.body.setAttribute('data-theme', state.settings.theme); document.body.setAttribute('data-theme-color', state.settings.color||'navy'); }
applyTheme();

/* ===== utilities ===== */
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
function gotoScreen(name){ screens.forEach(s=>s.classList.remove('active')); const t=document.getElementById(name); if(t) t.classList.add('active'); navItems.forEach(n=>n.classList.toggle('active', n.dataset.screen===name)); }
navItems.forEach(n=>n.addEventListener('click', ()=> gotoScreen(n.dataset.screen)));

/* ===== M3U parse logic =====
   - supports standard #EXTINF lines
   - groups entries by title; if same title multiple URLs => treat as multiple qualities
   - heuristics for quality: detect "1080","720","480" in url or title; else Auto
*/
function parseM3U(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const entries = []; let lastInfo = null;
  lines.forEach(line=>{
    if(line.startsWith('#EXTINF:')){
      lastInfo = line;
    } else if(line.startsWith('#')) {
      // ignore other tags
    } else if(/^https?:\/\//i.test(line)){
      // url line
      let title = lastInfo ? (lastInfo.split(',')[1] || lastInfo) : line;
      title = title.replace(/["']/g,'').trim();
      // try to extract quality from title or url
      const qLower = (title + ' ' + line).toLowerCase();
      let quality = 'Auto';
      if(/\b1080p|\b1080|fullhd/.test(qLower)) quality='1080p';
      else if(/\b720p|\b720/.test(qLower)) quality='720p';
      else if(/\b480p|\b480/.test(qLower)) quality='480p';
      // push raw
      entries.push({ title: title || line, url: line, quality });
      lastInfo = null;
    } else {
      // maybe local relative path - skip for simplicity
    }
  });

  // group by title
  const grouped = {};
  entries.forEach(e=>{
    const key = e.title || e.url;
    if(!grouped[key]) grouped[key] = { id: 'ch_' + Math.random().toString(36).slice(2,9), title: e.title, category:'Imported', language:'', thumbnail:e.title.slice(0,2).toUpperCase(), sources: {}, status:'Live', custom:true };
    // prefer Auto as first or create quality key
    if(!grouped[key].sources['Auto']) grouped[key].sources['Auto'] = e.url;
    // add by quality label
    if(e.quality && e.quality!=='Auto') grouped[key].sources[e.quality] = e.url;
  });

  // convert to array
  return Object.values(grouped);
}

/* ===== Import M3U UI ===== */
function showModal(html){ modalContent.innerHTML = html; overlay.classList.add('show'); }
function closeModal(){ overlay.classList.remove('show'); modalContent.innerHTML=''; }
overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal(); });

function openImportModal(){
  showModal(`
    <h3>Import M3U Playlist</h3>
    <p class="small">Choose a .m3u/.m3u8 file OR paste contents below. Remote streams should be HTTPS + CORS enabled.</p>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="fileInput" type="file" accept=".m3u,.m3u8,text/plain" />
      <button class="btn" id="doFile">Load File</button>
    </div>
    <label style="margin-top:8px">Or paste M3U text</label>
    <textarea id="m3uText" rows="8" placeholder="#EXTM3U..."></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn" id="importDo">Import</button>
      <button class="btn ghost" id="importCancel">Cancel</button>
    </div>
  `);

  qs('#importCancel').addEventListener('click', closeModal);
  qs('#doFile').addEventListener('click', ()=> {
    const fi = qs('#fileInput');
    if(!fi.files || fi.files.length===0) return alert('Choose a file first');
    const f = fi.files[0];
    const fr = new FileReader();
    fr.onload = ()=> {
      const text = fr.result;
      const parsed = parseM3U(text);
      if(parsed.length===0) return alert('No channels found in file.');
      // add to state: prepend
      state.channels = parsed.concat(state.channels);
      saveChannels(); populateAndRenderAll();
      closeModal();
      alert('Imported ' + parsed.length + ' channels');
    };
    fr.readAsText(f);
  });

  qs('#importDo').addEventListener('click', ()=> {
    const txt = qs('#m3uText').value.trim();
    if(!txt) return alert('Paste M3U text or load a file.');
    const parsed = parseM3U(txt);
    if(parsed.length===0) return alert('No channels found.');
    state.channels = parsed.concat(state.channels);
    saveChannels(); populateAndRenderAll();
    closeModal();
    alert('Imported ' + parsed.length + ' channels');
  });
}

/* ===== render helpers ===== */
function updateStats(){ statChannels.textContent = state.channels.length; statFavs.textContent = state.favorites.size; statCats.textContent = new Set(state.channels.map(c=>c.category)).size; }

function renderPopular(){
  popularEl.innerHTML = '';
  let list = state.channels.filter(c=>c.popular);
  if(list.length===0) list = state.channels.slice(0, 12);
  list.forEach(ch=>{
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `<div style="font-weight:700">${ch.title}</div><div class="small">${ch.category||'—'}</div>`;
    el.addEventListener('click', ()=> playChannel(ch.id));
    popularEl.appendChild(el);
  });
}

function renderCategories(){
  categoriesEl.innerHTML = '';
  const cats = Array.from(new Set(state.channels.map(c=>c.category).filter(Boolean)));
  cats.forEach(cat=>{
    const el = document.createElement('div'); el.className='card category';
    el.innerHTML = `<div style="font-weight:700">${cat}</div><div class="small">Explore</div>`;
    el.addEventListener('click', ()=> { gotoScreen('search'); searchInput.value=''; filterCategory.value=cat; applyFilters(); });
    categoriesEl.appendChild(el);
  });
}

function renderRecently(){
  recentlyEl.innerHTML='';
  state.recent.forEach(id=>{
    const ch = state.channels.find(c=>c.id===id);
    if(!ch) return;
    const el=document.createElement('div'); el.className='card';
    el.innerHTML = `<div style="font-weight:700">${ch.title}</div><div class="small">${ch.category||'—'}</div>`;
    el.addEventListener('click', ()=> playChannel(ch.id));
    recentlyEl.appendChild(el);
  });
}

/* Search & filters */
function populateFilters(){
  const cats = Array.from(new Set(state.channels.map(c=>c.category).filter(Boolean)));
  filterCategory.innerHTML = '<option value="">All categories</option>' + cats.map(c=>`<option>${c}</option>`).join('');
  const langs = Array.from(new Set(state.channels.map(c=>c.language).filter(Boolean)));
  filterLang.innerHTML = '<option value="">All languages</option>' + langs.map(l=>`<option>${l}</option>`).join('');
}
function renderSearch(results){
  searchResults.innerHTML='';
  if(results.length===0){ noResults.style.display='block'; return; } else noResults.style.display='none';
  results.forEach(ch=>{
    const el=document.createElement('div'); el.className='channel-card card';
    el.innerHTML = `<div class="channel-thumb">${ch.thumbnail||ch.title.slice(0,2)}</div>
      <div><div style="font-weight:700">${ch.title}</div><div class="small">${ch.category||'—'} • ${ch.language||'—'}</div></div>
      <div style="display:flex;justify-content:space-between;align-items:center"><small class="small">${ch.status||'Idle'}</small><div><button class="icon-btn play-btn" data-id="${ch.id}" title="Play"><i class="fa fa-play"></i></button><button class="icon-btn fav-btn" data-id="${ch.id}" title="Favorite"><i class="fa fa-heart"></i></button></div></div>`;
    searchResults.appendChild(el);
    el.querySelector('.play-btn').addEventListener('click', ()=> playChannel(ch.id));
    el.querySelector('.fav-btn').addEventListener('click', ()=> toggleFavorite(ch.id));
  });
}
function applyFilters(){
  const q = (searchInput.value||'').toLowerCase().trim();
  const cat = filterCategory.value; const lang = filterLang.value; const qual = filterQuality.value;
  let results = state.channels.filter(ch=>{
    if(q && !ch.title.toLowerCase().includes(q)) return false;
    if(cat && ch.category !== cat) return false;
    if(lang && ch.language !== lang) return false;
    if(qual && qual!==''){
      if(qual==='Auto') return ch.sources && ch.sources['Auto'];
      return ch.sources && Object.keys(ch.sources||{}).includes(qual);
    }
    return true;
  });
  renderSearch(results);
}

/* Favorites */
function toggleFavorite(id){
  if(state.favorites.has(id)) state.favorites.delete(id); else state.favorites.add(id);
  saveFavorites();
}
function renderFavorites(){
  favoritesList.innerHTML='';
  const favs = Array.from(state.favorites).map(id=>state.channels.find(c=>c.id===id)).filter(Boolean);
  if(favs.length===0){ favoritesEmpty.style.display='block'; return; } else favoritesEmpty.style.display='none';
  favs.forEach(ch=>{
    const el=document.createElement('div'); el.className='card';
    el.innerHTML = `<div style="font-weight:700">${ch.title}</div><div class="small">${ch.category||'—'}</div>`;
    el.addEventListener('click', ()=> playChannel(ch.id));
    favoritesList.appendChild(el);
  });
}

/* ===== Player & HLS ===== */
async function playChannel(id, quality='Auto'){
  const ch = state.channels.find(c=>c.id===id);
  if(!ch) return;
  state.current = ch;
  state.recent = [id].concat(state.recent.filter(x=>x!==id)); saveRecent(); renderRecently();
  // populate quality options
  qualitySelect.innerHTML = Object.keys(ch.sources||{}).map(k=>`<option>${k}</option>`).join('');
  qualitySelect.value = quality in (ch.sources||{}) ? quality : (ch.sources && ch.sources['Auto'] ? 'Auto' : Object.keys(ch.sources||{})[0]);
  playerTitle.textContent = ch.title;
  playerInfo.textContent = `${ch.category||'—'} • ${qualitySelect.value} • ${ch.status||'Idle'}`;
  btnFav.classList.toggle('active', state.favorites.has(ch.id));
  gotoScreen('player');
  const url = ch.sources[qualitySelect.value] || Object.values(ch.sources||{})[0];
  await loadStream(url);
  renderPlayerSuggested(ch.id);
}

async function loadStream(url){
  try{ if(state.hls){ state.hls.destroy(); state.hls = null; } }catch(e){}
  playerVideo.pause(); playerVideo.removeAttribute('src'); playerVideo.load();
  if(Hls.isSupported()){
    const hls = new Hls({ maxBufferLength:30 });
    state.hls = hls;
    hls.loadSource(url);
    hls.attachMedia(playerVideo);
    hls.on(Hls.Events.MANIFEST_PARSED, ()=>{ if(state.settings.autoplay) playerVideo.play().catch(()=>{}); });
    hls.on(Hls.Events.ERROR, (evt,data)=>{ console.warn('HLS error', data); });
  } else {
    playerVideo.src = url;
    if(state.settings.autoplay) playerVideo.play().catch(()=>{});
  }
}

/* render suggested */
function renderPlayerSuggested(currentId){
  playerSuggested.innerHTML='';
  state.channels.filter(c=>c.id!==currentId).slice(0,8).forEach(ch=>{
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `<div style="font-weight:700">${ch.title}</div><div class="small">${ch.category||'—'}</div>`;
    card.addEventListener('click', ()=> playChannel(ch.id));
    playerSuggested.appendChild(card);
  });
}

/* ===== Mini player ===== */
function openMini(){
  if(!state.current) return;
  const mini = document.createElement('div'); mini.className='mini-player';
  mini.innerHTML = `<video id="miniVideo" muted autoplay playsinline></video>
    <div style="position:absolute;right:6px;top:6px;display:flex;gap:6px"><button class="icon-btn" id="miniExpand"><i class="fa fa-expand"></i></button><button class="icon-btn" id="miniClose"><i class="fa fa-xmark"></i></button></div>`;
  miniContainer.innerHTML=''; miniContainer.appendChild(mini);
  // transfer stream: destroy previous hls and attach to mini video
  try{ if(state.hls){ state.hls.destroy(); state.hls = null; } }catch(e){}
  const url = state.current.sources['Auto'] || Object.values(state.current.sources||{})[0];
  if(Hls.isSupported()){ const hls = new Hls(); state.hls = hls; hls.loadSource(url); hls.attachMedia(mini.querySelector('#miniVideo')); } else mini.querySelector('#miniVideo').src = url;
  mini.querySelector('#miniClose').addEventListener('click', ()=> { try{ if(state.hls){ state.hls.destroy(); state.hls=null } }catch(e){} mini.remove(); });
  mini.querySelector('#miniExpand').addEventListener('click', ()=> { try{ if(state.hls){ state.hls.destroy(); state.hls=null } }catch(e){} mini.remove(); playChannel(state.current.id); });
}

/* ===== EPG modal ===== */
function showEPG(){
  document.querySelector('.app').classList.add('blurred');
  showModal(`<h3>Program Guide</h3><p class="small">Demo EPG — tap outside to close.</p><div style="max-height:320px;overflow:auto;margin-top:8px">${state.channels.slice(0,20).map(ch=>`<div style="padding:8px;border-radius:8px;background:var(--glass);margin-bottom:6px"><strong>${ch.title}</strong><div class="small">${new Date().toLocaleTimeString()} • ${ch.category||''}</div></div>`).join('')}</div><div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn" id="closeEPG">Close</button></div>`);
  qs('#closeEPG').addEventListener('click', ()=> { closeModal(); document.querySelector('.app').classList.remove('blurred'); });
  overlay.addEventListener('click', (e)=> { if(e.target===overlay) document.querySelector('.app').classList.remove('blurred'); }, { once:true });
}

/* ===== Misc UI wiring ===== */
document.getElementById('openImport').addEventListener('click', openImportModal);
document.getElementById('btnImportTop').addEventListener('click', openImportModal);
document.getElementById('btnClearAll').addEventListener('click', ()=> { if(confirm('Clear all imported channels?')) { state.channels=[]; saveChannels(); populateAndRenderAll(); }});

document.getElementById('openSettings').addEventListener('click', ()=> gotoScreen('settings'));
document.getElementById('openEPG').addEventListener('click', showEPG);
qs('#goSearch').addEventListener('click', ()=> gotoScreen('search'));
document.getElementById('clearFilters').addEventListener('click', ()=> { searchInput.value=''; filterCategory.value=''; filterLang.value=''; filterQuality.value=''; applyFilters(); });

searchInput.addEventListener('input', applyFilters);
filterCategory.addEventListener('change', applyFilters);
filterLang.addEventListener('change', applyFilters);
filterQuality.addEventListener('change', applyFilters);

btnBack.addEventListener('click', ()=> gotoScreen('home'));
btnFav.addEventListener('click', ()=> { if(!state.current) return; toggleFavorite(state.current.id); btnFav.classList.toggle('active', state.favorites.has(state.current.id)); });
btnMini.addEventListener('click', ()=> { if(!state.current) return openMini(); });
btnFullscreen.addEventListener('click', ()=> { const el = playerVideo; if(el.requestFullscreen) el.requestFullscreen(); });

document.getElementById('toggleTheme').addEventListener('click', ()=> { state.settings.theme = state.settings.theme === 'light' ? 'dark' : 'light'; saveSettings(); });
document.getElementById('themeColor').addEventListener('change', (e)=> { state.settings.color = e.target.value; saveSettings(); });

document.getElementById('autoplayToggle').addEventListener('change', (e)=> { state.settings.autoplay = e.target.checked; saveSettings(); });
document.getElementById('pipToggle').addEventListener('change', (e)=> { state.settings.pip = e.target.checked; saveSettings(); });

document.getElementById('clearCache').addEventListener('click', ()=> { if(confirm('Clear localStorage?')) { localStorage.clear(); location.reload(); }});
document.getElementById('exportFavs').addEventListener('click', ()=> {
  const data = JSON.stringify(Array.from(state.favorites).map(id=>state.channels.find(c=>c.id===id)).filter(Boolean), null, 2);
  const blob = new Blob([data], { type:'application/json' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='flux_favs.json'; a.click(); URL.revokeObjectURL(url);
});

/* ===== Populate and render ===== */
function populateAndRenderAll(){
  populateFilters(); renderPopular(); renderCategories(); renderRecently(); updateStats(); renderFavorites(); applySettingsUI();
}
function applySettingsUI(){ qs('#themeColor').value = state.settings.color || 'navy'; qs('#autoplayToggle').checked = !!state.settings.autoplay; qs('#pipToggle').checked = !!state.settings.pip; applyTheme(); }
populateAndRenderAll();

/* initial search results: show channels */
applyFilters();

/* keyboard escape */
document.addEventListener('keydown', (e)=> { if(e.key==='Escape'){ closeModal(); document.querySelectorAll('.mini-player').forEach(mp=>mp.remove()); } });

/* ===== small helpers ===== */
function populateFilters(){ const cats=Array.from(new Set(state.channels.map(c=>c.category).filter(Boolean))); filterCategory.innerHTML = '<option value="">All categories</option>' + cats.map(c=>`<option>${c}</option>`).join(''); const langs=Array.from(new Set(state.channels.map(c=>c.language).filter(Boolean))); filterLang.innerHTML = '<option value="">All languages</option>' + langs.map(l=>`<option>${l}</option>`).join(''); }

function renderFavorites(){ renderFavorites = (()=>{}); /* placeholder to avoid redefinition */ }
function renderFavorites(){ /* implemented earlier; keep consistent */ }

/* ensure functions exist - recreate renderFavorites properly */
function renderFavorites(){
  favoritesList.innerHTML=''; const favs = Array.from(state.favorites).map(id=>state.channels.find(c=>c.id===id)).filter(Boolean);
  if(favs.length===0){ favoritesEmpty.style.display='block'; return; } else favoritesEmpty.style.display='none';
  favs.forEach(ch=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML = `<div style="font-weight:700">${ch.title}</div><div class="small">${ch.category||'—'}</div>`; el.addEventListener('click', ()=> playChannel(ch.id)); favoritesList.appendChild(el); });
}

/* final update stats function */
function updateStats(){ statChannels.textContent = state.channels.length; statFavs.textContent = state.favorites.size; statCats.textContent = new Set(state.channels.map(c=>c.category)).size; }

/* expose some debugging on window for mobile console if needed */
window.__flux = { state, parseM3U };

/* If user directly wants to load a remote M3U file by URL (optional helper) */
function importFromUrl(url){
  fetch(url).then(r=>r.text()).then(txt=>{ const parsed = parseM3U(txt); state.channels = parsed.concat(state.channels); saveChannels(); populateAndRenderAll(); alert('Imported ' + parsed.length + ' channels from URL'); }).catch(e=>alert('Fetch failed: '+e.message));
}

/* END */
</script>
</body>
</html>
